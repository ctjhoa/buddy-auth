<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>buddy.auth.accessrules documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">buddy-auth</span> <span class="project-version">3.0.1</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="user-guide.html"><div class="inner"><span>User Guide</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>buddy</span></div></div></li><li class="depth-2"><a href="buddy.auth.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>auth</span></div></a></li><li class="depth-3 branch current"><a href="buddy.auth.accessrules.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>accessrules</span></div></a></li><li class="depth-3"><a href="buddy.auth.backends.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>backends</span></div></a></li><li class="depth-4 branch"><a href="buddy.auth.backends.httpbasic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>httpbasic</span></div></a></li><li class="depth-4 branch"><a href="buddy.auth.backends.session.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>session</span></div></a></li><li class="depth-4"><a href="buddy.auth.backends.token.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>token</span></div></a></li><li class="depth-3 branch"><a href="buddy.auth.http.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>http</span></div></a></li><li class="depth-3 branch"><a href="buddy.auth.middleware.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>middleware</span></div></a></li><li class="depth-3"><a href="buddy.auth.protocols.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>protocols</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="buddy.auth.accessrules.html#var-compile-access-rule"><div class="inner"><span>compile-access-rule</span></div></a></li><li class="depth-1"><a href="buddy.auth.accessrules.html#var-compile-access-rules"><div class="inner"><span>compile-access-rules</span></div></a></li><li class="depth-1"><a href="buddy.auth.accessrules.html#var-compile-rule-handler"><div class="inner"><span>compile-rule-handler</span></div></a></li><li class="depth-1"><a href="buddy.auth.accessrules.html#var-error"><div class="inner"><span>error</span></div></a></li><li class="depth-1"><a href="buddy.auth.accessrules.html#var-IRuleHandlerResponse"><div class="inner"><span>IRuleHandlerResponse</span></div></a></li><li class="depth-2 branch"><a href="buddy.auth.accessrules.html#var-get-value"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>get-value</span></div></a></li><li class="depth-2"><a href="buddy.auth.accessrules.html#var-success.3F"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>success?</span></div></a></li><li class="depth-1"><a href="buddy.auth.accessrules.html#var-restrict"><div class="inner"><span>restrict</span></div></a></li><li class="depth-1"><a href="buddy.auth.accessrules.html#var-success"><div class="inner"><span>success</span></div></a></li><li class="depth-1"><a href="buddy.auth.accessrules.html#var-wrap-access-rules"><div class="inner"><span>wrap-access-rules</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">buddy.auth.accessrules</h1><div class="doc"><div class="markdown"><p>Access Rules system for ring based applications.</p></div></div><div class="public anchor" id="var-compile-access-rule"><h3>compile-access-rule</h3><div class="usage"><code>(compile-access-rule accessrule)</code></div><div class="doc"><div class="markdown"><p>Receives an access rule and returns a compiled version of it.</p>
<p>The plain version of access rule consists of one hash-map with with <code>:uri</code> and <code>:handler</code> keys. <code>:uri</code> is a url match syntax that will be used for matching the url and <code>:handler</code> is a rule handler.</p>
<p>Little overview of aspect of access rules:</p>
<pre><code>[{:uri "/foo"
  :handler user-access}
 {:uris ["/bar" "/baz"]
  :handler admin-access}]
</code></pre>
<p>The clout library (<a href="https://github.com/weavejester/clout">https://github.com/weavejester/clout</a>) for matching the <code>:uri</code>.</p>
<p>It also has support for more advanced matching using plain regular expressions, which are matched against the full request uri:</p>
<pre><code>[{:pattern #"^/foo$"
  :handler user-access}
</code></pre>
<p>An access rule can also match against certain HTTP methods, by using the <code>:request-method</code> option. <code>:request-method</code> can be a keyword or a set of keywords.</p>
<pre><code>[{:pattern #"^/foo$"
  :handler user-access
  :request-method :get}
</code></pre>
<p>The compilation process consists in transforming the plain version into an optimized one in order to avoid unnecessary overhead to the request process time.</p>
<p>The compiled version of access rule has a very similar format with the plain one. The difference is that <code>:handler</code> is a compiled version, and <code>:pattern</code> or <code>:uri</code> is replaced by matcher function.</p>
<p>Little overview of aspect of compiled version of acces rule:</p>
<pre><code>[{:matcher #&lt;accessrules$compile_access_rule$fn__13092$fn__13095...&gt;
  :handler #&lt;accessrules$compile_rule_handler$fn__14040$fn__14043...&gt;
</code></pre></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L175">view source</a></div></div><div class="public anchor" id="var-compile-access-rules"><h3>compile-access-rules</h3><div class="usage"><code>(compile-access-rules accessrules)</code></div><div class="doc"><div class="markdown"><p>Compile a list of access rules.</p>
<p>For more information, see the docstring of <code>compile-access-rule</code> function.</p></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L255">view source</a></div></div><div class="public anchor" id="var-compile-rule-handler"><h3>compile-rule-handler</h3><div class="usage"><code>(compile-rule-handler rule)</code></div><div class="doc"><div class="markdown"><p>Receives a rule handler and returns a compiled version of it.</p>
<p>The compiled version of a rule handler consists of one function that accepts a request as first parameter and returns the result of the evaluation of it.</p>
<p>The rule can be a simple function or logical expression. Logical expression is expressed using a hashmap:</p>
<pre><code>{:or [f1 f2]}
{:and [f1 f2]}
</code></pre>
<p>Logical expressions can be nested as deep as you want:</p>
<pre><code>{:or [f1 {:and [f2 f3]}]}
</code></pre>
<p>The rule handler as unit of work, should return a <code>success</code> or <code>error</code>. <code>success</code> is a simple mark that means that handler passes the validation and <code>error</code> is a mark that means that rule does not pass the validation.</p>
<p>An error mark can return a ring response that will be returned to the http client or string message that will be passed to <code>on-error</code> handler if it exists, or returned as bad-request response with message as response body.</p>
<p>Example of success marks:</p>
<ul>
  <li><code>true</code></li>
  <li><code>(success)</code></li>
</ul>
<p>Example of error marks:</p>
<ul>
  <li><code>nil</code></li>
  <li><code>false</code></li>
  <li><code>(error "Error msg")</code></li>
  <li><code>(error {:status 400 :body "Unauthorized"})</code></li>
</ul></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L92">view source</a></div></div><div class="public anchor" id="var-error"><h3>error</h3><div class="usage"><code>(error)</code><code>(error v)</code></div><div class="doc"><div class="markdown"><p>Function that returns a failure state from one access rule handler.</p></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L82">view source</a></div></div><div class="public anchor" id="var-IRuleHandlerResponse"><h3>IRuleHandlerResponse</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>Abstraction for uniform handling of rule handler return values. It comes with default implementation for nil and boolean types.</p></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-get-value"><h3>get-value</h3><div class="usage"><code>(get-value _)</code></div><div class="doc"><div class="markdown"><p>Get a handler response value.</p></div></div></div><div class="public anchor" id="var-success.3F"><h3>success?</h3><div class="usage"><code>(success? _)</code></div><div class="doc"><div class="markdown"><p>Check if a response is a success.</p></div></div></div></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L26">view source</a></div></div><div class="public anchor" id="var-restrict"><h3>restrict</h3><div class="usage"><code>(restrict handler rule)</code></div><div class="doc"><div class="markdown"><p>Like <code>wrap-access-rules</code> middleware but works as decorator. It is intended to be used with compojure routing library or similar. Example:</p>
<pre><code>(defn login-ctrl [req] ...)
(defn admin-ctrl [req] ...)

(defroutes app
  (ANY "/login" [] login-ctrl)
  (GET "/admin" [] (restrict admin-ctrl {:handler admin-access ;; Mandatory
                                           :on-error my-reject-handler)
</code></pre>
<p>This decorator allows using the same access rules but without any url matching algorithm, however it has the disadvantage of accoupling your routers code with access rules.</p></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L369">view source</a></div></div><div class="public anchor" id="var-success"><h3>success</h3><div class="usage"><code>(success)</code><code>(success v)</code></div><div class="doc"><div class="markdown"><p>Function that returns a success state from one access rule handler.</p></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L76">view source</a></div></div><div class="public anchor" id="var-wrap-access-rules"><h3>wrap-access-rules</h3><div class="usage"><code>(wrap-access-rules handler &amp; [{:keys [policy rules], :or {policy :allow}, :as opts}])</code></div><div class="doc"><div class="markdown"><p>A ring middleware that helps to define access rules for ring handler.</p>
<p>This is an example of access rules list that <code>wrap-access-rules</code> middleware expects:</p>
<pre><code>[{:uri "/foo/*"
  :handler user-access}
 {:uri "/bar/*"
  :handler {:or [user-access admin-access]}}
 {:uri "/baz/*"
  :handler {:and [user-access {:or [admin-access operator-access]}]}}]
</code></pre>
<p>All access rules are evaluated in order and the process stops when a match is found.</p>
<p>See docstring of <code>compile-rule-handler</code> for documentation about rule handlers.</p></div></div><div class="src-link"><a href="https://github.com/funcool/buddy-auth/blob/master/src/buddy/auth/accessrules.clj#L326">view source</a></div></div></div></body></html>